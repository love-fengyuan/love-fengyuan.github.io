<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>nginx | 永远在路上 生命不息 学习不止 | 请道上大佬，多多指教</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="nginx">
    <meta name="description" content="Nginx服务Nginx现状​nginx 是当前的使用最广泛的webserver ,支持http正向/反向代理，支持TCP/UDP层代理，nginx在全部网站中占比较高，而且一直在增加。当下最时尚的webserver非nginx莫属。 Nginx特点 性能好 非阻塞IO/高并发(asyncio/aiohttp),支持文件IO 多worker，thread pool（线程池- 线程队列） 基于rbt">
<meta name="keywords" content="nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx">
<meta property="og:url" content="http://www.baidu.com/2019/05/06/nginx/index.html">
<meta property="og:site_name" content="永远在路上 生命不息 学习不止">
<meta property="og:description" content="Nginx服务Nginx现状​nginx 是当前的使用最广泛的webserver ,支持http正向/反向代理，支持TCP/UDP层代理，nginx在全部网站中占比较高，而且一直在增加。当下最时尚的webserver非nginx莫属。 Nginx特点 性能好 非阻塞IO/高并发(asyncio/aiohttp),支持文件IO 多worker，thread pool（线程池- 线程队列） 基于rbt">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_compare.png">
<meta property="og:updated_time" content="2019-05-05T12:18:50.862Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="nginx">
<meta name="twitter:description" content="Nginx服务Nginx现状​nginx 是当前的使用最广泛的webserver ,支持http正向/反向代理，支持TCP/UDP层代理，nginx在全部网站中占比较高，而且一直在增加。当下最时尚的webserver非nginx莫属。 Nginx特点 性能好 非阻塞IO/高并发(asyncio/aiohttp),支持文件IO 多worker，thread pool（线程池- 线程队列） 基于rbt">
<meta name="twitter:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_compare.png">
    
        <link rel="alternate" type="application/atom+xml" title="永远在路上 生命不息 学习不止" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.png">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpeg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">YuanFeng</h5>
          <a href="mailto:yfxxaq@163.com" title="yfxxaq@163.com" class="mail">yfxxaq@163.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/">
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives">
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags">
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories">
                <i class="icon icon-lg icon-th-list"></i>
                类别
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/love-fengyuan" target="_blank">
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/custom">
                <i class="icon icon-lg icon-link"></i>
                测试
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">nginx</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">nginx</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-05-05T19:56:58.000Z" itemprop="datePublished" class="page-time">
  2019-05-05
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/nginx/">nginx</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Nginx服务"><span class="post-toc-number">1.</span> <span class="post-toc-text">Nginx服务</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Nginx现状"><span class="post-toc-number">2.</span> <span class="post-toc-text">Nginx现状</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Nginx特点"><span class="post-toc-number">3.</span> <span class="post-toc-text">Nginx特点</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Nginx工作原理"><span class="post-toc-number">4.</span> <span class="post-toc-text">Nginx工作原理</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-master主进程"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">(1)master主进程</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-worker-工作进程"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">(2)worker 工作进程</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-Nginx的IO处理过程"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">(3) Nginx的IO处理过程</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Nginx-安装与配置"><span class="post-toc-number">5.</span> <span class="post-toc-text">Nginx 安装与配置</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#5-OpenResty-使用"><span class="post-toc-number">6.</span> <span class="post-toc-text">5 OpenResty 使用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#配置文件"><span class="post-toc-number">6.1.</span> <span class="post-toc-text">配置文件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#启动测试"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">启动测试</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#负载均衡策略"><span class="post-toc-number">6.3.</span> <span class="post-toc-text">负载均衡策略</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#RR-（轮询策略）"><span class="post-toc-number">6.3.1.</span> <span class="post-toc-text">RR （轮询策略）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#权重"><span class="post-toc-number">6.3.2.</span> <span class="post-toc-text">权重</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ip-hash"><span class="post-toc-number">6.3.3.</span> <span class="post-toc-text">ip_hash</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#作为静态资源服务器"><span class="post-toc-number">6.4.</span> <span class="post-toc-text">作为静态资源服务器</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#关于URL路由规则"><span class="post-toc-number">6.5.</span> <span class="post-toc-text">关于URL路由规则</span></a></li></ol></li></ol>
        </nav>
    </aside>
    
<article id="post-nginx" class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">nginx</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-05-05 19:56:58" datetime="2019-05-05T19:56:58.000Z" itemprop="datePublished">2019-05-05</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/nginx/">nginx</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style="display:none">
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="Nginx服务"><a href="#Nginx服务" class="headerlink" title="Nginx服务"></a>Nginx服务</h2><h2 id="Nginx现状"><a href="#Nginx现状" class="headerlink" title="Nginx现状"></a>Nginx现状</h2><p>​nginx 是当前的使用最广泛的webserver ,支持http正向/反向代理，支持TCP/UDP层代理，nginx在全部网站中占比较高，而且一直在增加。当下最时尚的webserver非nginx莫属。</p>
<h2 id="Nginx特点"><a href="#Nginx特点" class="headerlink" title="Nginx特点"></a>Nginx特点</h2><ul>
<li>性能好<ul>
<li>非阻塞IO/高并发(asyncio/aiohttp),支持文件IO</li>
<li>多worker，thread pool（线程池- 线程队列）</li>
<li>基于rbtree的定时器</li>
<li>系统特性的持续支持</li>
</ul>
</li>
<li>功能强大<ul>
<li>webserver/cache/keepalive/pipeline等等</li>
<li>各种upstream的支持【fastcgi/http/…】</li>
<li>输出灵活【chunk/zip/…】</li>
<li>在不断的发展 http2,tcp,udp,proxy…</li>
</ul>
</li>
<li>运维的友好【这个对于开发和部署很重要】<ul>
<li>配置非常规范【个人认为：约定及规范是最好的实践】</li>
<li>热加载和热更新【后文会详细介绍，能在二进制的层面热更新】</li>
<li>日志强大【真的很强的，很多变量支撑】</li>
</ul>
</li>
<li>扩展强大</li>
</ul>
<p>​     下图是nginx、apache和lighttpd的一个对比。系统压力，内存占用，upstream支持等多个方面都非常不错<br>[<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://cuihuan.net/wp_content/new/nginx1/nginx_compare.png" alt="nginx对比图](nginx/nginx_compare.png)" title>
                </div>
                <div class="image-caption">nginx对比图](nginx/nginx_compare.png)</div>
            </figure></p>
<p>HTTPS = HTTP + SSL</p>
<h2 id="Nginx工作原理"><a href="#Nginx工作原理" class="headerlink" title="Nginx工作原理"></a>Nginx工作原理</h2><p>​Nginx的运行方式：<code>master-worker多进程模式运行，单线程/非阻塞执行</code></p>
<p>​Nginx 启动后生成master，master会启动conf数量的<code>worker进程</code>，当用户的请求过来之后，由不同的worker调起<code>执行线程</code>，非阻塞的执行请求。这种运行方式相对于<code>apache的进程执行</code>相对轻量很多，支撑的并发性也会高很多。   </p>
<p>​Nginx 默认采用守护模式启动，守护模式让master进程启动后在后台运行。在Nginx运行期间主要由一个master主进程和多个worker进程（worker数目一般与cpu数目相同）</p>
<h3 id="1-master主进程"><a href="#1-master主进程" class="headerlink" title="(1)master主进程"></a>(1)master主进程</h3><ul>
<li>master主进程主要是管理worker进程，对网络事件进行收集和分发：</li>
</ul>
<ol>
<li>接收来自外界的信号</li>
<li>向各worker进程发送信号</li>
<li>监控worker进程的运行状态，当worker进程退出后(异常情况下)，会自动重新启动新的worker进程</li>
</ol>
<h3 id="2-worker-工作进程"><a href="#2-worker-工作进程" class="headerlink" title="(2)worker 工作进程"></a>(2)worker 工作进程</h3><p>​     nginx用一个独立的worker进程来处理一个请求，一个worker进程可以处理多个请求：</p>
<p>​     a.  当一个worker进程在accept这个连接之后，就开始读取请求，解析请求，处理请求，产生数据后，再返回给客户端，最后才断开连接。</p>
<p>​     b.  一个请求，完全由worker进程来处理，而且只在一个worker进程中处理。采用这种方式的好处：</p>
<ul>
<li><ul>
<li>节省锁带来的开销。对于每个worker进程来说，独立的进程，不需要加锁，所以省掉了锁带来的开销，同时在编程以及问题查上时，也会方便很多</li>
<li>独立进程，减少风险。</li>
<li>采用独立的进程，可以让互相之间不会影响，一个进程退出后，其它进程还在工作，服务不会中断，master进程则很快重新启动新的worker进程。</li>
<li>在一次请求里无需进程切换</li>
</ul>
</li>
</ul>
<h3 id="3-Nginx的IO处理过程"><a href="#3-Nginx的IO处理过程" class="headerlink" title="(3) Nginx的IO处理过程"></a>(3) Nginx的IO处理过程</h3><p>​一般的Tcp Socket处理过程：</p>
<p>​服务端：fd = socket.socket   —&gt; fd.bind()   —&gt; fd.listen()   —&gt; accept()  等待客户端连接  —&gt;  send / recv  —&gt; close()</p>
<p>客户端：fd = socket.socket  —&gt; fd.connect()  与服务端建立连接  —&gt; recv / send   —&gt; close()</p>
<p>​Nginx的网络IO处理通常使用epoll，epoll函数使用了I/O复用模型。与I/O阻塞模型比较，I/O复用模型的优势在于可以同时等待多个（而不只是一个）套接字描述符就绪。Nginx的epoll工作流程如下：</p>
<ul>
<li><ul>
<li>master进程先建好需要listen的socket后，然后再fork出多个woker进程，这样每个work进程都可以去accept这个socket</li>
<li>当一个client连接到来时，所有accept的work进程都会受到通知，但只有一个进程可以accept成功，其它的则会accept失败，Nginx提供了一把共享锁accept_mutex来保证同一时刻只有一个work进程在accept连接，从而解决惊群问题。</li>
<li>当一个worker进程accept这个连接后，就开始读取请求，解析请求，处理请求，产生数据后，再返回给客户端，最后才断开连接，这样一个完成的请求就结束了.</li>
</ul>
</li>
</ul>
<h2 id="Nginx-安装与配置"><a href="#Nginx-安装与配置" class="headerlink" title="Nginx 安装与配置"></a>Nginx 安装与配置</h2><p>​Nginx服务学习我们借助于一个第三方库Openresty，它本身就是把nginx核心代码做了一层封装，你完全可以把它当成Nginx使用。</p>
<p>​OpenResty 是一个基于 <a href="https://openresty.org/cn/nginx.html" target="_blank" rel="noopener">Nginx</a> 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p>
<p>​OpenResty 的目标是让你的Web服务直接跑在 <a href="https://openresty.org/cn/nginx.html" target="_blank" rel="noopener">Nginx</a> 服务内部，充分利用 <a href="https://openresty.org/cn/nginx.html" target="_blank" rel="noopener">Nginx</a> 的非阻塞 I/O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。</p>
<p>Openresty下载页：</p>
<p><a href="https://openresty.org/cn/download.html" target="_blank" rel="noopener">https://openresty.org/cn/download.html</a></p>
<p>下载版本：wget  <a href="https://openresty.org/download/openresty-1.11.2.5.tar.gz" target="_blank" rel="noopener">https://openresty.org/download/openresty-1.11.2.5.tar.gz</a>  (Ubuntu 16.x)</p>
<p>最新版本： wget  <a href="https://openresty.org/download/openresty-1.13.6.2.tar.gz" target="_blank" rel="noopener">https://openresty.org/download/openresty-1.13.6.2.tar.gz</a> (Ubuntu 17.10)</p>
<p>性能测试工具 Apache AB test</p>
<p>安装过程：</p>
<p>（1）安装依赖库：</p>
<pre><code>sudo apt install libpcre3  libpcre3-dev

sudo apt install openssl libssl-dev
</code></pre><p>（2）安装openresty </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#将openresty安装到/opt/openresty目录下</span><br><span class="line">sudo mkdir /opt/openresty   </span><br><span class="line">#修改组和用户权限 apple用户名 : apple组</span><br><span class="line">sudo chown -Rf apple:apple /opt/openresty/</span><br><span class="line">tar -xzvf openresty-1.11.2.5.tar.gz</span><br><span class="line">cd openresty-1.11.2.5 </span><br><span class="line">./configure  --prefix=/opt/openresty    (注:./configure --help 查看更多的配置选项)</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>至此，安装完成，安装openresty就在/opt/openresty目录下。</p>
<p>（3）目录介绍</p>
<pre><code>bin                          openresty 的启动文件

COPYRIGHT             版权文件

luajit                        lua虚拟环境luajit

lualib                       lua实现的第三方库，包括redis， mysql， upload， upstream，websocket等等。

nginx                      nginx核心功能块

pod     resty.index    site
</code></pre><p>​openresty不只是提供了nginx功能，而且提供了丰富的工具集，我们可以做除了负载均衡和反向代理之外的很多事情，快速搭建出高性能web服务。</p>
<p>查看进程和端口：</p>
<p>ps -ef | grep 80</p>
<p>netstat -tunpl | grep 80  # </p>
<p>修改  vim  /opt/openresty/nginx/conf/nginx.conf 中，将listen 80改成 8080</p>
<p>启动nginx服务：</p>
<p>$ /opt/openresty/nginx/sbin/nginx</p>
<p>打开页面：<a href="http://172.16.245.180:8080/" target="_blank" rel="noopener">http://172.16.245.180:8080/</a> </p>
<p>​          <a href="http://localhost:8080/" target="_blank" rel="noopener">http://localhost:8080/</a></p>
<p>可以看到 Welcome   to  OpenResty ！ 的页面，表示已经安装成功！</p>
<p>如果之前已安装了nginx 删除或停止它的服务：</p>
<p>​sudo apt remove nginx 或</p>
<p>​sudo servie nginx stop </p>
<h2 id="5-OpenResty-使用"><a href="#5-OpenResty-使用" class="headerlink" title="5 OpenResty 使用"></a>5 OpenResty 使用</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>Openresty 框架的配置和nginx配置方法一样，配置文件: /opt/openresty/nginx/conf/nginx.conf</p>
<p>​Nginx主要通过nginx.conf文件进行配置使用。在nginx.conf文件中主要分为：</p>
<ul>
<li><ul>
<li>全局块：一些全局的属性，在运行时与具体业务功能（比如http服务或者email服务代理）无关的一些参数，比如工作进程数，运行的身份等</li>
<li>event块：参考事件模型，单个进程最大连接数等</li>
<li>http块：设定http服务器</li>
<li>server块：配置虚拟主机</li>
<li>location块：配置请求路由及页面的处理情况等</li>
</ul>
</li>
</ul>
<p>关键参数说明：</p>
<p>nginx进程数，建议设置为等于CPU总核心数。</p>
<p>worker_processes 8;</p>
<p>全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]</p>
<p>error_log /usr/local/nginx/logs/error.log info;</p>
<p>进程pid文件</p>
<p>pid /opt/openresty/nginx/logs/nginx.pid;</p>
<p>指定进程可以打开的最大描述符：数目</p>
<p>工作模式与连接数上限</p>
<p>这个指令是指当一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（ulimit -n）与nginx进程数相除，但是nginx分配请求并不是那么均匀，所以最好与ulimit -n 的值保持一致。</p>
<p>worker_rlimit_nofile 65535;</p>
<p>虚拟主机的配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    #监听端口</span><br><span class="line">    listen 80;</span><br><span class="line"></span><br><span class="line">    #域名可以有多个，用空格隔开, cat /etc/hosts</span><br><span class="line">    server_name www.jd.com jd.com; </span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    root /data/www/jd;</span><br><span class="line">    </span><br><span class="line">    #url 请求路由</span><br><span class="line">    location  /hello &#123;</span><br><span class="line">        default_type text/html;</span><br><span class="line">        content_by_lua &apos;</span><br><span class="line">            ngx.say(&quot;&lt;p&gt;Hello, World!&lt;/p&gt;&quot;)</span><br><span class="line">        &apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#负载均衡配置</span><br><span class="line">upstream piao.jd.com &#123;</span><br><span class="line">    #upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weight参数表示权值，权值越高被分配到的几率越大。</span><br><span class="line">    server 192.168.80.121:80 weight=3;</span><br><span class="line">    server 192.168.80.122:80 weight=2;</span><br><span class="line">    server 192.168.80.123:80 weight=3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h3><p>拷贝我们的工程文件 artproject.zip，解压到某一个目录 eg:  /home/apple根目录下</p>
<p>配置nginx配置文件nginx.conf，添加如下信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">location /hello</span><br><span class="line">&#123;</span><br><span class="line">   default_type   text/html;</span><br><span class="line">   content_by_lua  &apos;</span><br><span class="line">       ngx.say(&quot;&lt;p&gt;Hello, World!&lt;/p&gt;&quot;)&apos;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 静态文件，nginx自己处理</span><br><span class="line">location  ~ ^/(images|javascript|js|css|flash|media|static)/ &#123;</span><br><span class="line">   root   /home/apple/artproject/art;</span><br><span class="line">   # 过期1天，静态文件不怎么更新，过期可以设大一点，如果频繁更新，则可以设置得小一点。</span><br><span class="line">   expires  1d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>$ /opt/openresty/nginx/sbin/nginx -s stop, quit, reopen, reload</p>
<p>$ /opt/openresty/nginx/sbin/nginx -t  测试</p>
<p>nginx: the configuration file /opt/openresty/nginx/conf/nginx.conf syntax is ok</p>
<p>nginx: configuration file /opt/openresty/nginx/conf/nginx.conf test is successful</p>
<p>查看页面效果</p>
<p><a href="http://172.16.245.180:8080/hello" target="_blank" rel="noopener">http://172.16.245.180:8080/hello</a></p>
<p><a href="http://172.16.245.180:8080/static/admin/pages/index.html" target="_blank" rel="noopener">http://172.16.245.180:8080/static/admin/pages/index.html</a></p>
<h3 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h3><p>​负载均衡也是Nginx常用的一个功能，负载均衡其意思就是分摊到多个操作单元上进行执行，例如Web服务器、FTP服务器、企业关键应用服务器和其它关键任务服务器等，从而共同完成工作任务。</p>
<p>​Nginx目前支持自带3种负载均衡策略，还有2种常用的第三方策略</p>
<h4 id="RR-（轮询策略）"><a href="#RR-（轮询策略）" class="headerlink" title="RR （轮询策略）"></a>RR （轮询策略）</h4><p>​按照轮询（默认）方式进行负载，每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。虽然这种方式简便、成本低廉。但缺点是：可靠性低和负载分配不均衡。</p>
<h4 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h4><p>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream test&#123;</span><br><span class="line">    server localhost:8080 weight=9;</span><br><span class="line">    server localhost:8081 weight=1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时8080和8081分别占90%和10%。</p>
<h4 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h4><p>上面的2种方式都有一个问题，那就是下一个请求来的时候请求可能分发到另外一个服务器，当我们的程序不是无状态的时候（采用了session保存数据），这时候就有一个很大的很问题了，比如把登录信息保存到了session中，那么跳转到另外一台服务器的时候就需要重新登录了，所以很多时候我们需要一个客户只访问一个服务器，那么就需要用iphash了，iphash的每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream test &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>fair(第三方) </li>
</ol>
<p>按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123; </span><br><span class="line">    fair; </span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>url_hash(第三方) </li>
</ol>
<p>按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。 在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123; </span><br><span class="line">    hash $request_uri; </span><br><span class="line">    hash_method crc32; </span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理动态请求转发到某一个服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">​         location = / &#123;  </span><br><span class="line"></span><br><span class="line">​                  proxy_pass   http://localhost:8080  </span><br><span class="line"></span><br><span class="line">​       &#125;</span><br></pre></td></tr></table></figure></p>
<p>​此处的proxy_pass 对应的服务，会导到上述upstream入口</p>
<h3 id="作为静态资源服务器"><a href="#作为静态资源服务器" class="headerlink" title="作为静态资源服务器"></a>作为静态资源服务器</h3><p>​Nginx本身也是一个静态资源的服务器，当只有静态资源的时候，就可以使用Nginx来做服务器，同时现在也很流行动静分离，就可以通过Nginx来实现，动静分离是让动态网站里的动态网页根据一定规则把不变的资源和经常变的资源区分开来，动静资源做好了拆分以后，我们就可以根据静态资源的特点将其做缓存操作（CDN），这就是网站静态化处理的核心思路。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 静态文件，nginx自己处理</span><br><span class="line">location  ~ ^/(images|javascript|js|css|flash|media|static)/ &#123;</span><br><span class="line">   root   /home/apple/artproject/art;</span><br><span class="line">   # 过期1天，静态文件不怎么更新，过期可以设大一点，如果频繁更新，则可以设置得小一点。</span><br><span class="line">   expires  1d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="关于URL路由规则"><a href="#关于URL路由规则" class="headerlink" title="关于URL路由规则"></a>关于URL路由规则</h3><p>语法规则：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location [=|~|~*|^~] /uri/ </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line">​     … </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>= 开头表示精确匹配</p>
<p>^~ 开头表示uri以某个常规字符串开头，理解为匹配 url路径即可。</p>
<p>~ 开头表示区分大小写的正则匹配</p>
<p>~*  开头表示不区分大小写的正则匹配</p>
<p>!~和!~*分别为区分大小写不匹配及不区分大小写不匹配 的正则</p>
<p>/ 通用匹配，任何请求都会匹配到。</p>
<p>多个location配置的情况下匹配顺序为：</p>
<p>首先匹配 =，其次匹配^~, 其次是按文件中顺序的正则匹配，最后是交给 / 通用匹配。当有匹配成功时候，停止匹配，按当前匹配规则处理请求。</p>
<p>例子，有如下匹配规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;</span><br><span class="line">   #规则A</span><br><span class="line">&#125;</span><br><span class="line">location = /login &#123;</span><br><span class="line">   #规则B</span><br><span class="line">&#125;</span><br><span class="line">location ^~ /static/ &#123;</span><br><span class="line">   #规则C</span><br><span class="line">&#125;</span><br><span class="line">location ~ \.(gif|jpg|png|js|css)$ &#123;</span><br><span class="line">   #规则D</span><br><span class="line">&#125;</span><br><span class="line">location ~* \.png$ &#123;</span><br><span class="line">   #规则E</span><br><span class="line">&#125;</span><br><span class="line">location !~ \.xhtml$ &#123;</span><br><span class="line">   #规则F</span><br><span class="line">&#125;</span><br><span class="line">location !~* \.xhtml$ &#123;</span><br><span class="line">   #规则G</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">   #规则H</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么产生的效果如下:</p>
<p>访问根目录/， 比如<a href="http://localhost/" target="_blank" rel="noopener">http://localhost/</a> 将匹配规则A<br>访问 <a href="http://localhost/login" target="_blank" rel="noopener">http://localhost/login</a> 将匹配规则B，<a href="http://localhost/register" target="_blank" rel="noopener">http://localhost/register</a> 则匹配规则H<br>访问 <a href="http://localhost/static/a.html" target="_blank" rel="noopener">http://localhost/static/a.html</a> 将匹配规则C<br>访问 <a href="http://localhost/a.gif" target="_blank" rel="noopener">http://localhost/a.gif</a>, <a href="http://localhost/b.jpg" target="_blank" rel="noopener">http://localhost/b.jpg</a> 将匹配规则D和规则E，但是规则D顺序优先，规则E不起作用，而 <a href="http://localhost/static/c.png" target="_blank" rel="noopener">http://localhost/static/c.png</a> 则优先匹配到规则C<br>访问 <a href="http://localhost/a.PNG" target="_blank" rel="noopener">http://localhost/a.PNG</a> 则匹配规则E，而不会匹配规则D，因为规则E不区分大小写。</p>
<p>访问 <a href="http://localhost/a.xhtml" target="_blank" rel="noopener">http://localhost/a.xhtml</a> 不会匹配规则F和规则G，<a href="http://localhost/a.XHTML不会匹配规则G，因为不区分大小写。规则F，规则G属于排除法，符合匹配规则但是不会匹配到，所以想想看实际应用中哪里会用到。" target="_blank" rel="noopener">http://localhost/a.XHTML不会匹配规则G，因为不区分大小写。规则F，规则G属于排除法，符合匹配规则但是不会匹配到，所以想想看实际应用中哪里会用到。</a></p>
<p>访问 <a href="http://localhost/category/id/1111" target="_blank" rel="noopener">http://localhost/category/id/1111</a> 则最终匹配到规则H，因为以上规则都不匹配，这个时候应该是nginx转发请求给后端应用服务器，比如FastCGI（php），tomcat（jsp），nginx作为方向代理服务器存在。</p>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-05-05T12:18:50.862Z" itemprop="dateUpdated">2019-05-05 12:18:50</time>
</span><br>


        
        生命不息，学习不止
        
    </div>
    <footer>
        <a href="http://www.baidu.com">
            <img src="/img/avatar.jpeg" alt="YuanFeng">
            YuanFeng
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.baidu.com/2019/05/06/nginx/&title=《nginx》 — 永远在路上 生命不息 学习不止&pic=http://www.baidu.com/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.baidu.com/2019/05/06/nginx/&title=《nginx》 — 永远在路上 生命不息 学习不止&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.baidu.com/2019/05/06/nginx/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《nginx》 — 永远在路上 生命不息 学习不止&url=http://www.baidu.com/2019/05/06/nginx/&via=http://www.baidu.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.baidu.com/2019/05/06/nginx/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/05/06/django/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">django</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/05/06/python_design_pattern/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">python设计模式</h4>
      </a>
    </div>
  
</nav>



    
















</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style="display:none">
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style="display:none">
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p>
            <span>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></span>
            <span>YuanFeng &copy; 2019</span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.baidu.com/2019/05/06/nginx/&title=《nginx》 — 永远在路上 生命不息 学习不止&pic=http://www.baidu.com/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.baidu.com/2019/05/06/nginx/&title=《nginx》 — 永远在路上 生命不息 学习不止&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.baidu.com/2019/05/06/nginx/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《nginx》 — 永远在路上 生命不息 学习不止&url=http://www.baidu.com/2019/05/06/nginx/&via=http://www.baidu.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.baidu.com/2019/05/06/nginx/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAAB0klEQVR42u3ay27rIBQF0Pz/T7vTK1UmewOm1tViVJHYWXSAzuvzidf1z/q9f/f9u2fv3rZt4eLiLnOv4cp/st0Z798eCRcX9yA3uYzyC2v8bPKd231cXNxXcscByvgaGr8TFxf3/+Dml1Syg4uL+zZukvzk5ZL28nokV8PFxV3g5lXK5/5+pL6Li4s7xb3K1V467adf3oyLi3uEm18oSeiTByh5+IKLi/tX3HEZok1I2lJpW3LFxcV9mlsEFu25Y+jmiAwXF3cTd65Rmrdg8yTqy/txcXGPcNcHsPKwpm3eRLkaLi7uA9z8gYS+oTk6/vfh4uIe5LaljbbpkpQ+o3AHFxf3CLedeVgfukqSqC/JDy4u7sPcycLEcqAzN+qBi4t7hjvXu5y74JLGarSPi4t7kLs+pNWWOfLrsq7v4uLibuLmaUybLCXhUfEGXFzc49w8HKmTlvLAn/bncXFxN3GvcuVJTnukqIKLi4t7hNuOROTN1/ypuckKXFzcp7lzgxR5utIecinQwcXF3cpdH61YaZkUwx+4uLiv5OZF0nxoo/hFXFzcV3LbYyQNlaKEiouLe5Dbtkba4Yn2DXWTFRcXdyu3vUra8seuhi4uLu4R7g/8bUjnQ0toMQAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };



</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '小可爱，快回来吧！';
            clearTimeout(titleTime);
        } else {
            document.title = '(つェ⊂)咦!又好了!';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
